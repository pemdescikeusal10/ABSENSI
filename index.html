<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <title>Absensi Desa</title>
</head>
<body>

<h2>Dashboard Absensi</h2>

<button onclick="setType('masuk')">Absen Masuk</button>
<button onclick="setType('pulang')">Absen Pulang</button>

<br><br>

<div id="reader" style="width:300px;"></div>
<p id="status"></p>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyaBQL76y5q7AQ_UvzstULmdxurzcwiO1jrKwt3Y-IAxd9meoVgwL9VfdnytAQvQPOe/exec";

let type = null;
let lat = null;
let lng = null;

navigator.geolocation.getCurrentPosition(
  pos => {
    lat = pos.coords.latitude;
    lng = pos.coords.longitude;
  },
  err => {
    alert("GPS harus diaktifkan");
  }
);

function setType(t){
  type = t;
  alert("Mode: " + t);
}

function onScanSuccess(decodedText){

  if(!type){
    alert("Pilih Masuk / Pulang dulu");
    return;
  }

  if(!lat){
    alert("GPS belum siap");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      token: decodedText,
      type: type,
      lat: lat,
      lng: lng,
      email: localStorage.getItem("email"),
      nama: localStorage.getItem("nama")
    })
  })
  .then(res => res.json())
  .then(res => {
    document.getElementById("status").innerText = res.status;
  });
}

let scanner = new Html5QrcodeScanner("reader",{fps:10,qrbox:250});
scanner.render(onScanSuccess);
</script>

</body>

</html>
